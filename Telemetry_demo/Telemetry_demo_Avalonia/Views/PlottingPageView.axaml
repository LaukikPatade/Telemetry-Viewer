<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.Avalonia;assembly=LiveChartsCore.SkiaSharpView.Avalonia"
             xmlns:measure="clr-namespace:LiveChartsCore.Measure;assembly=LiveChartsCore"
             xmlns:conv="clr-namespace:Telemetry_demo_Avalonia.Converters"
             x:Class="Telemetry_demo_Avalonia.Views.PlottingPageView">
    <UserControl.Resources>
        <conv:EqualsConverter x:Key="EqualsConverter" />
        <conv:NullToBoolConverter x:Key="NullToBoolConverter" />
        <conv:SidebarWidthConverter x:Key="SidebarWidthConverter" />
        <conv:SidebarToggleIconConverter x:Key="SidebarToggleIconConverter" />
        <conv:InverseBoolConverter x:Key="InverseBoolConverter" />
    </UserControl.Resources>
    <Grid ColumnDefinitions="Auto,*" RowDefinitions="*,Auto">
        <!-- Sidebar for plotting controls -->
        <Border Grid.Column="0" Background="#23272F"
                Width="{Binding IsSidebarCollapsed, Converter={StaticResource SidebarWidthConverter}}"
                IsVisible="{Binding Tiles.Count, Converter={StaticResource NullToBoolConverter}}" Padding="0,16,0,0">
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" MaxHeight="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=ActualHeight}">
                <StackPanel>
                    <!-- Toggle button always visible -->
                    <Button Content="{Binding IsSidebarCollapsed, Converter={StaticResource SidebarToggleIconConverter}}"
                            Command="{Binding ToggleSidebarCommand}" Width="32" Height="32" Margin="8"/>
                    <!-- Only show controls when expanded -->
                    <Expander Header="Plot Controls" IsExpanded="True" IsVisible="{Binding IsSidebarCollapsed, Converter={StaticResource InverseBoolConverter}}">
                        <StackPanel>
                            <!-- Active Configuration Panels -->
                            <TextBlock Text="Active Configurations:" FontWeight="Bold" Foreground="White" Margin="0,0,8,0"/>
                            <ItemsControl ItemsSource="{Binding ActiveConfigPanels}" Margin="0,8,0,0">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Expander Header="{Binding Config.ConnectionName}" IsExpanded="{Binding IsExpanded}" Margin="0,4,0,0">
                                        <StackPanel>
                                            <!-- X-Axis Range Control -->
                                            <Border BorderBrush="White" BorderThickness="1" CornerRadius="4" Padding="8" Margin="0,8,0,8">
                                                <StackPanel>
                                                    <TextBlock Text="X-Axis Range:" FontWeight="Bold" Foreground="White" Margin="0,0,0,4"/>
                                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                        <TextBlock Text="Samples:" Foreground="White" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                                        <TextBox Text="{Binding XAxisRange}" Width="80" Margin="0,0,8,0"/>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                            
                                            <!-- Y-Axis Range Control -->
                                            <Border BorderBrush="White" BorderThickness="1" CornerRadius="4" Padding="8" Margin="0,8,0,8">
                                                <StackPanel>
                                                    <TextBlock Text="Y-Axis Range:" FontWeight="Bold" Foreground="White" Margin="0,0,0,4"/>
                                                    <StackPanel Orientation="Vertical" Margin="0,4,0,0">
                                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                            <TextBlock Text="Min:" Foreground="White" VerticalAlignment="Center" Margin="0,0,4,0" Width="30"/>
                                                            <TextBox Text="{Binding YAxisMin}" Width="80" Margin="0,0,0,0"/>
                                                        </StackPanel>
                                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,0">
                                                            <TextBlock Text="Max:" Foreground="White" VerticalAlignment="Center" Margin="0,0,4,0" Width="30"/>
                                                            <TextBox Text="{Binding YAxisMax}" Width="80" Margin="0,0,0,0"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                            
                                            <!-- Combined Set/Auto Buttons -->
                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,8">
                                                <Button Content="Set" Command="{Binding SetBothAxisRangeCommand}" Width="60" Height="25" Margin="0,0,8,0"/>
                                                <Button Content="Auto" Command="{Binding ResetBothAxisRangeCommand}" Width="60" Height="25" Margin="0,0,0,0"/>
                                            </StackPanel>
                                            
                                            <!-- Channel Visibility Controls -->
                                            <TextBlock Text="Channels:" FontWeight="Bold" Foreground="White" Margin="0,8,0,4"/>
                                            <ItemsControl ItemsSource="{Binding Tile.Channels}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox Content="{Binding Name}" IsChecked="{Binding IsSelected, Mode=TwoWay}" Foreground="White"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                            
                                            <!-- Control Buttons (only visible for live data) -->
                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0" IsVisible="{Binding Tile.IsLiveView}">
                                                <Button Content="⏸" Command="{Binding Tile.PauseCommand}" Width="30" Height="30" Margin="0,0,4,0"/>
                                                <Button Content="▶" Command="{Binding Tile.ResumeCommand}" Width="30" Height="30" Margin="4,0,4,0"/>
                                                <Button Content="⏹" Command="{Binding DisconnectCommand}" Width="30" Height="30" Margin="4,0,0,0" Background="Red"/>
                                            </StackPanel>
                                            
                                            <!-- Skip to Index control (only visible for historical data) -->
                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0" IsVisible="{Binding Tile.IsPaused}">
                                                <TextBlock Text="Skip to:" Foreground="White" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                                <TextBox Text="{Binding SkipToIndex}" Width="60" Margin="0,0,4,0"/>
                                                <Button Content="Go" Command="{Binding SkipToIndexCommand}" Width="40" Height="25" Margin="0,0,0,0"/>
                                            </StackPanel>
                                            
                                            <!-- Roll-back controls (only visible when paused) -->
                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0" IsVisible="{Binding Tile.IsPaused}">
                                                <Button Content="←" Command="{Binding Tile.RollBackCommand}" Width="40" Height="32" Margin="0,0,4,0"/>
                                                <Button Content="→" Command="{Binding Tile.RollForwardCommand}" Width="40" Height="32" Margin="4,0,0,0"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Expander>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        

                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>
        </Border>
        <!-- Main grid area -->
        <Grid Grid.Column="1" Grid.Row="0" Margin="0,32,0,0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
            <!-- Dynamic tile grid -->
            <Grid x:Name="TileGrid" Margin="8">
                <!-- Grid definitions will be set dynamically in code-behind -->
                </Grid>
        </Grid>
        <!-- Global controls -->
        <StackPanel Grid.Column="1" Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,8,0,0" Spacing="16">
            <TextBlock Text="Modular Tile System" VerticalAlignment="Center" FontWeight="Bold"/>
        </StackPanel>
    </Grid>
</UserControl> 